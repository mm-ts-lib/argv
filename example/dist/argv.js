"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const process = require("process");
class CmdLineParser {
    constructor(progName, progVersion, cmdDesc, cmdDefine) {
        this._defaultCmdKey = null;
        this._lastArg = null;
        this._progName = progName;
        this._progVersion = progVersion;
        this._cmdDesc = cmdDesc;
        this._cmdLine = cmdDefine;
        this._addVersionArg();
        this._addHelpArg();
    }
    _addVersionArg() {
        const cmdline = this._cmdLine;
        cmdline['version'] = {
            short: 'v',
            desc: 'show current version',
            value: false,
        };
    }
    _addHelpArg() {
        const cmdline = this._cmdLine;
        cmdline['help'] = {
            short: 'h',
            desc: 'show current version',
            value: false,
        };
    }
    _findShort(short) {
        const cmdline = this._cmdLine;
        const keys = Object.keys(cmdline);
        for (let v of keys) {
            if (cmdline[v].short === short) {
                return v;
            }
        }
        return null;
    }
    _getValue(valType, val) {
        let a = val;
        if (typeof valType === 'number') {
            a = Number(val);
        }
        else if (typeof valType === 'boolean') {
            a = !['false', '0', 'null'].includes(val.toLowerCase());
        }
        return a;
    }
    _setLastArg(arg) {
        const cmdline = this._cmdLine;
        this._lastArg = arg;
    }
    parse() {
        const cmdline = this._cmdLine;
        const commandArg = Object.keys(cmdline).find(function (key) {
            return cmdline[key].short === null;
        });
        process.argv.forEach((arg, i) => {
            if (i === 0 || i === 1)
                return;
            if (arg.startsWith("--")) {
                const a = arg.substr(2);
                if (cmdline[a]) {
                    this._setLastArg(a);
                }
                else {
                    this.printHelp('Invalid arg:' + a, true);
                }
            }
            else if (arg.startsWith("-")) {
                const a = arg.substr(1);
                const findedArg = this._findShort(a);
                if (findedArg) {
                    this._setLastArg(findedArg);
                }
                else {
                    this.printHelp('Invalid arg:' + a, true);
                }
            }
            else {
                if (this._lastArg === null) {
                    if (!commandArg) {
                        this.printHelp('Not Need Command Param:', true);
                    }
                    else {
                        cmdline[commandArg].value = arg;
                    }
                }
                else {
                    if (cmdline[this._lastArg]) {
                        console.log('------!!', this._lastArg, arg);
                        cmdline[this._lastArg].value = this._getValue(cmdline[this._lastArg].value, arg);
                    }
                    else {
                        this.printHelp('Parse CmdLine Error:' + this._lastArg + "," + arg, true);
                    }
                }
            }
        });
        if (cmdline.version.value) {
            console.log(this._progName + ' v' + this._progVersion);
            process.exit(1);
        }
        else if (cmdline.help.value) {
            this.printHelp(undefined, true);
        }
        return this._cmdLine;
    }
    printHelp(err, exit) {
        if (err) {
            console.log("ERROR:" + err);
        }
        console.log(this._progName + ' v' + this._progVersion);
        console.log(this._cmdDesc);
        console.log('Usage:');
        const cmdline = this._cmdLine;
        Object.keys(cmdline).forEach((cmd) => {
            const short = cmdline[cmd].short ? `[-${cmdline[cmd].short}]` : '';
            console.log(`\t--${cmd} ${short}: ${cmdline[cmd].desc}`);
        });
        if (exit) {
            process.exit(1);
        }
    }
}
function default_1(progName, progVersion, desc, define) {
    const parsed = new CmdLineParser(progName, progVersion, desc, define).parse();
    Object.keys(parsed).map(function (key, index) {
        parsed[key] = parsed[key].value;
    });
    return parsed;
}
exports.default = default_1;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXJndi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9hcmd2LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsbUNBQW9DO0FBRXBDO0lBVUUsWUFBWSxRQUFnQixFQUFFLFdBQW1CLEVBQUUsT0FBZSxFQUFFLFNBQVk7UUFKeEUsbUJBQWMsR0FBa0IsSUFBSSxDQUFDO1FBQ3JDLGFBQVEsR0FBa0IsSUFBSSxDQUFDO1FBSXJDLElBQUksQ0FBQyxTQUFTLEdBQUcsUUFBUSxDQUFDO1FBQzFCLElBQUksQ0FBQyxZQUFZLEdBQUcsV0FBVyxDQUFDO1FBQ2hDLElBQUksQ0FBQyxRQUFRLEdBQUcsT0FBTyxDQUFDO1FBQ3hCLElBQUksQ0FBQyxRQUFRLEdBQUcsU0FBUyxDQUFDO1FBRTFCLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUN0QixJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDckIsQ0FBQztJQUdPLGNBQWM7UUFDcEIsTUFBTSxPQUFPLEdBQVEsSUFBSSxDQUFDLFFBQVEsQ0FBQztRQUNuQyxPQUFPLENBQUMsU0FBUyxDQUFDLEdBQUc7WUFDbkIsS0FBSyxFQUFFLEdBQUc7WUFDVixJQUFJLEVBQUUsc0JBQXNCO1lBQzVCLEtBQUssRUFBRSxLQUFLO1NBQ2IsQ0FBQTtJQUNILENBQUM7SUFFTyxXQUFXO1FBQ2pCLE1BQU0sT0FBTyxHQUFRLElBQUksQ0FBQyxRQUFRLENBQUM7UUFDbkMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxHQUFHO1lBQ2hCLEtBQUssRUFBRSxHQUFHO1lBQ1YsSUFBSSxFQUFFLHNCQUFzQjtZQUM1QixLQUFLLEVBQUUsS0FBSztTQUNiLENBQUE7SUFDSCxDQUFDO0lBT08sVUFBVSxDQUFDLEtBQWE7UUFDOUIsTUFBTSxPQUFPLEdBQVEsSUFBSSxDQUFDLFFBQVEsQ0FBQztRQUNuQyxNQUFNLElBQUksR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ2xDLEdBQUcsQ0FB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Q1QsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNsQixDQUFDO0lBQ0gsQ0FBQztDQUNGO0FBZUQsbUJBQTZDLFFBQWdCLEVBQUUsV0FBbUIsRUFBRSxJQUFZLEVBQUUsTUFBUztJQUt6RyxNQUFNLE1BQU0sR0FBUSxJQUFJLGFBQWEsQ0FBQyxRQUFRLEVBQUUsV0FBVyxFQUFFLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUNuRixNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxVQUFVLEdBQUcsRUFBRSxLQUFLO1FBQzFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDO0lBQ2xDLENBQUMsQ0FBQyxDQUFDO0lBQ0gsTUFBTSxDQUFDLE1BQU0sQ0FBQztBQUNoQixDQUFDO0FBVkQsNEJBVUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcHJvY2VzcyA9IHJlcXVpcmUoJ3Byb2Nlc3MnKTtcblxuY2xhc3MgQ21kTGluZVBhcnNlcjxUPiB7XG4gIC8vIOengeacieaIkOWRmFxuICBwcml2YXRlIF9wcm9nTmFtZTogc3RyaW5nO1xuICBwcml2YXRlIF9wcm9nVmVyc2lvbjogc3RyaW5nO1xuICBwcml2YXRlIF9jbWREZXNjOiBzdHJpbmc7XG4gIHByaXZhdGUgX2NtZExpbmU6IFQ7XG4gIHByaXZhdGUgX2RlZmF1bHRDbWRLZXk6IHN0cmluZyB8IG51bGwgPSBudWxsO1xuICBwcml2YXRlIF9sYXN0QXJnOiBzdHJpbmcgfCBudWxsID0gbnVsbDtcblxuICAvLyDmnoTpgKDlh73mlbBcbiAgY29uc3RydWN0b3IocHJvZ05hbWU6IHN0cmluZywgcHJvZ1ZlcnNpb246IHN0cmluZywgY21kRGVzYzogc3RyaW5nLCBjbWREZWZpbmU6IFQpIHtcbiAgICB0aGlzLl9wcm9nTmFtZSA9IHByb2dOYW1lO1xuICAgIHRoaXMuX3Byb2dWZXJzaW9uID0gcHJvZ1ZlcnNpb247XG4gICAgdGhpcy5fY21kRGVzYyA9IGNtZERlc2M7XG4gICAgdGhpcy5fY21kTGluZSA9IGNtZERlZmluZTtcbiAgICAvLyDmt7vliqDlj4LmlbDmmL7npLrniYjmnKzkv6Hmga9cbiAgICB0aGlzLl9hZGRWZXJzaW9uQXJnKCk7XG4gICAgdGhpcy5fYWRkSGVscEFyZygpO1xuICB9XG5cbiAgLy8g56eB5pyJ5Ye95pWwXG4gIHByaXZhdGUgX2FkZFZlcnNpb25BcmcoKSB7XG4gICAgY29uc3QgY21kbGluZTogYW55ID0gdGhpcy5fY21kTGluZTtcbiAgICBjbWRsaW5lWyd2ZXJzaW9uJ10gPSB7XG4gICAgICBzaG9ydDogJ3YnLFxuICAgICAgZGVzYzogJ3Nob3cgY3VycmVudCB2ZXJzaW9uJyxcbiAgICAgIHZhbHVlOiBmYWxzZSwgLy8g57y655yB5YC8XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBfYWRkSGVscEFyZygpIHtcbiAgICBjb25zdCBjbWRsaW5lOiBhbnkgPSB0aGlzLl9jbWRMaW5lO1xuICAgIGNtZGxpbmVbJ2hlbHAnXSA9IHtcbiAgICAgIHNob3J0OiAnaCcsXG4gICAgICBkZXNjOiAnc2hvdyBjdXJyZW50IHZlcnNpb24nLFxuICAgICAgdmFsdWU6IGZhbHNlLCAvLyDnvLrnnIHlgLxcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICog5p+l5om+55+t5Y+C5pWw5YWz6IGU5a+56LGhXG4gICAqIEBwYXJhbSBzaG9ydCDnn63lj4LmlbDvvIzkuI3lkKsg4oCYLeKAmVxuICAgKiBAcmV0dXJucyDnn63lj4LmlbDlr7nlupTnmoQgYXJnIG5hbWVcbiAgICovXG4gIHByaXZhdGUgX2ZpbmRTaG9ydChzaG9ydDogc3RyaW5nKTogc3RyaW5nIHwgbnVsbCB7XG4gICAgY29uc3QgY21kbGluZTogYW55ID0gdGhpcy5fY21kTGluZTtcbiAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoY21kbGluZSk7XG4gICAgZm9yIChsZXQgdiBvZiBrZXlzKSB7XG4gICAgICBpZiAoY21kbGluZVt2XS5zaG9ydCA9PT0gc2hvcnQpIHtcbiAgICAgICAgcmV0dXJuIHY7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgcHJpdmF0ZSBfZ2V0VmFsdWU8VDE+KHZhbFR5cGU6IFQxLCB2YWw6IHN0cmluZyk6IFQxIHtcbiAgICBsZXQgYTogYW55ID0gdmFsO1xuICAgIGlmICh0eXBlb2YgdmFsVHlwZSA9PT0gJ251bWJlcicpIHtcbiAgICAgIGEgPSBOdW1iZXIodmFsKTtcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWxUeXBlID09PSAnYm9vbGVhbicpIHtcbiAgICAgIGEgPSAhWydmYWxzZScsICcwJywgJ251bGwnXS5pbmNsdWRlcyh2YWwudG9Mb3dlckNhc2UoKSk7XG4gICAgfVxuICAgIHJldHVybiBhO1xuICB9XG5cbiAgcHJpdmF0ZSBfc2V0TGFzdEFyZyhhcmc6IHN0cmluZyk6IHZvaWQge1xuICAgIGNvbnN0IGNtZGxpbmU6IGFueSA9IHRoaXMuX2NtZExpbmU7XG4gICAgdGhpcy5fbGFzdEFyZyA9IGFyZztcbiAgICAvLyDlpoLmnpzmmK8gYm9vbCDnsbvlnovnmoTlj4LmlbDvvIznm7TmjqXorr7nva7kuLp0cnVlXG4gICAgLy8gaWYgKHR5cGVvZiBjbWRsaW5lW2FyZ10udmFsdWUgPT09ICdib29sZWFuJykge1xuICAgIC8vICAgY21kbGluZVthcmddLnZhbHVlID0gdHJ1ZTtcbiAgICAvLyB9IGVsc2Uge1xuICAgIC8vICAgLy8g6K6+572ubGFzdEFyZ+WQjeensFxuICAgIC8vIH1cbiAgfVxuXG4gIC8vIOWFrOacieWHveaVsFxuICAvLyDmiafooYzop6PmnpDvvIzov5Tlm57nu5PmnpxcbiAgcGFyc2UoKTogVCB7XG4gICAgLy8g6YGN5Y6G5omA5pyJ5Y+C5pWw77yM5qOA5rWL5piv5ZCm5piv5Y+C5pWw5a6a5LmJ77yM5qOA5rWL5piv6ZW/5Y+C5pWw6L+Y5piv55+t5Y+C5pWwXG4gICAgY29uc3QgY21kbGluZTogYW55ID0gdGhpcy5fY21kTGluZTtcbiAgICAvLyDmo4DmtYvlkb3ku6Tlj4LmlbBcbiAgICBjb25zdCBjb21tYW5kQXJnID0gT2JqZWN0LmtleXMoY21kbGluZSkuZmluZChmdW5jdGlvbiAoa2V5OiBhbnkpIHtcbiAgICAgIHJldHVybiBjbWRsaW5lW2tleV0uc2hvcnQgPT09IG51bGw7XG4gICAgfSlcblxuICAgIC8vIGRlYnVnZ2VyO1xuICAgIHByb2Nlc3MuYXJndi5mb3JFYWNoKChhcmcsIGkpID0+IHtcbiAgICAgIC8vIOi3s+i/h+WPguaVsCAwLDFcbiAgICAgIGlmIChpID09PSAwIHx8IGkgPT09IDEpIHJldHVybjtcblxuICAgICAgaWYgKGFyZy5zdGFydHNXaXRoKFwiLS1cIikpIHtcbiAgICAgICAgLy8g6ZW/5Y+C5pWwXG4gICAgICAgIGNvbnN0IGEgPSBhcmcuc3Vic3RyKDIpO1xuICAgICAgICBpZiAoY21kbGluZVthXSkge1xuICAgICAgICAgIHRoaXMuX3NldExhc3RBcmcoYSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5wcmludEhlbHAoJ0ludmFsaWQgYXJnOicgKyBhLCB0cnVlKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmIChhcmcuc3RhcnRzV2l0aChcIi1cIikpIHtcbiAgICAgICAgLy8g55+t5Y+C5pWwXG4gICAgICAgIGNvbnN0IGEgPSBhcmcuc3Vic3RyKDEpO1xuICAgICAgICBjb25zdCBmaW5kZWRBcmcgPSB0aGlzLl9maW5kU2hvcnQoYSk7XG4gICAgICAgIGlmIChmaW5kZWRBcmcpIHtcbiAgICAgICAgICB0aGlzLl9zZXRMYXN0QXJnKGZpbmRlZEFyZyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5wcmludEhlbHAoJ0ludmFsaWQgYXJnOicgKyBhLCB0cnVlKTtcbiAgICAgICAgfVxuXG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyDnrKzkuIDkuKrlkb3ku6TmiJbogIXmmK/kuIrkuIDkuKrlj4LmlbDnmoTlgLxcbiAgICAgICAgaWYgKHRoaXMuX2xhc3RBcmcgPT09IG51bGwpIHtcbiAgICAgICAgICBpZiAoIWNvbW1hbmRBcmcpIHtcbiAgICAgICAgICAgIC8vIOWmguaenOacquiuvue9ruWRveS7pOWPguaVsOWImeaKpemUmVxuICAgICAgICAgICAgdGhpcy5wcmludEhlbHAoJ05vdCBOZWVkIENvbW1hbmQgUGFyYW06JywgdHJ1ZSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNtZGxpbmVbY29tbWFuZEFyZ10udmFsdWUgPSBhcmc7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIC8vIOino+aekOS4uuS4iuS4gOS4quWPguaVsOeahOWAvFxuICAgICAgICAgIGlmIChjbWRsaW5lW3RoaXMuX2xhc3RBcmddKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnLS0tLS0tISEnLCB0aGlzLl9sYXN0QXJnLCBhcmcpO1xuICAgICAgICAgICAgY21kbGluZVt0aGlzLl9sYXN0QXJnXS52YWx1ZSA9IHRoaXMuX2dldFZhbHVlKGNtZGxpbmVbdGhpcy5fbGFzdEFyZ10udmFsdWUsIGFyZyk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMucHJpbnRIZWxwKCdQYXJzZSBDbWRMaW5lIEVycm9yOicgKyB0aGlzLl9sYXN0QXJnICsgXCIsXCIgKyBhcmcsIHRydWUpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pXG5cbiAgICAvLyDmo4DmtYvmmK/lkKbmmK/nvLrnnIHlkb3ku6QsLS1oZWxwIOaIluiAhSAtLXZlcnNpb27vvIzmiafooYznvLrnnIHlkb3ku6TlubbpgIDlh7pcbiAgICBpZiAoY21kbGluZS52ZXJzaW9uLnZhbHVlKSB7XG4gICAgICBjb25zb2xlLmxvZyh0aGlzLl9wcm9nTmFtZSArICcgdicgKyB0aGlzLl9wcm9nVmVyc2lvbik7XG4gICAgICBwcm9jZXNzLmV4aXQoMSk7XG4gICAgfSBlbHNlIGlmIChjbWRsaW5lLmhlbHAudmFsdWUpIHtcbiAgICAgIHRoaXMucHJpbnRIZWxwKHVuZGVmaW5lZCwgdHJ1ZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuX2NtZExpbmU7XG4gIH1cblxuICBwcmludEhlbHAoZXJyPzogc3RyaW5nLCBleGl0PzogYm9vbGVhbikge1xuICAgIGlmIChlcnIpIHtcbiAgICAgIGNvbnNvbGUubG9nKFwiRVJST1I6XCIgKyBlcnIpO1xuICAgIH1cbiAgICAvLyDovpPlh7rniYjmnKxcbiAgICBjb25zb2xlLmxvZyh0aGlzLl9wcm9nTmFtZSArICcgdicgKyB0aGlzLl9wcm9nVmVyc2lvbik7XG5cbiAgICAvLyDovpPlh7rlkb3ku6TnroDku4tcbiAgICBjb25zb2xlLmxvZyh0aGlzLl9jbWREZXNjKTtcblxuICAgIC8vIOi+k+WHuuS9v+eUqOivtOaYjlxuICAgIGNvbnNvbGUubG9nKCdVc2FnZTonKTtcbiAgICBjb25zdCBjbWRsaW5lOiBhbnkgPSB0aGlzLl9jbWRMaW5lO1xuICAgIE9iamVjdC5rZXlzKGNtZGxpbmUpLmZvckVhY2goKGNtZCkgPT4ge1xuICAgICAgLy8gc2hvcnQg5Y+C5pWw5LiN5Li656m65YiZ5pi+56S655+t5Y+C5pWwXG4gICAgICBjb25zdCBzaG9ydCA9IGNtZGxpbmVbY21kXS5zaG9ydCA/IGBbLSR7Y21kbGluZVtjbWRdLnNob3J0fV1gIDogJyc7XG4gICAgICBjb25zb2xlLmxvZyhgXFx0LS0ke2NtZH0gJHtzaG9ydH06ICR7Y21kbGluZVtjbWRdLmRlc2N9YCk7XG4gICAgfSlcblxuICAgIGlmIChleGl0KSB7XG4gICAgICBwcm9jZXNzLmV4aXQoMSk7XG4gICAgfVxuICB9XG59XG5cbi8v5a6a5LmJ5pig5bCEdmFsdWXnsbvlnotcbnR5cGUgSUNtZEl0ZW0gPSB7XG4gIFtrOiBzdHJpbmddOiB7XG4gICAgc2hvcnQ6IHN0cmluZyB8IG51bGwsXG4gICAgdmFsdWU6IHN0cmluZyB8IG51bWJlciB8IGJvb2xlYW4sXG4gICAgZGVzYzogc3RyaW5nXG4gIH1cbn07XG5cbi8vIOS7juWOn+Wni+WvueixoeWumuS5ieS4ree7hOe7h+aWsOWvueixoVxudHlwZSBJVmFsdWU8VCBleHRlbmRzIElDbWRJdGVtPiA9IHtbUCBpbiBrZXlvZiBUXTogVFtQXVsndmFsdWUnXX07XG5cbi8vIOWvvOWHuuaYoOWwhOWvueixoe+8jFxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gPFQgZXh0ZW5kcyBJQ21kSXRlbT4ocHJvZ05hbWU6IHN0cmluZywgcHJvZ1ZlcnNpb246IHN0cmluZywgZGVzYzogc3RyaW5nLCBkZWZpbmU6IFQpXG4gIDogUmVhZG9ubHk8SVZhbHVlPFQ+PiB7XG4gIC8vIG1hcCDop6PmnpDlkI7nmoRjbWTlr7nosaFcbiAgLy8gY29uc3QgbWFwQ21kTGluZSA9IF8ubWFwVmFsdWVzKG5ldyBDbWRMaW5lUGFyc2VyKHByb2dOYW1lLCBwcm9nVmVyc2lvbiwgZGVzYywgZGVmaW5lKVxuICAvLyAgIC5wYXJzZSgpLCBvID0+IG8udmFsdWUpO1xuICBjb25zdCBwYXJzZWQ6IGFueSA9IG5ldyBDbWRMaW5lUGFyc2VyKHByb2dOYW1lLCBwcm9nVmVyc2lvbiwgZGVzYywgZGVmaW5lKS5wYXJzZSgpO1xuICBPYmplY3Qua2V5cyhwYXJzZWQpLm1hcChmdW5jdGlvbiAoa2V5LCBpbmRleCkge1xuICAgIHBhcnNlZFtrZXldID0gcGFyc2VkW2tleV0udmFsdWU7XG4gIH0pO1xuICByZXR1cm4gcGFyc2VkO1xufVxuXG4iXX0=